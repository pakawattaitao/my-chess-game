<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Chess Online - Custom Room ID</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #1a1a1a; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .container { background: #2d3436; padding: 20px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); width: 100%; max-width: 850px; display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        
        .game-side { flex: 1; min-width: 350px; max-width: 450px; }
        .chat-side { width: 320px; background: #34495e; border-radius: 10px; display: flex; flex-direction: column; height: 550px; }

        /* Setup Room Panel */
        .setup-panel { background: #34495e; padding: 15px; border-radius: 10px; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        .setup-group { display: flex; gap: 10px; margin-top: 5px; }
        .input-style { flex: 1; padding: 10px; border-radius: 5px; border: none; font-size: 1rem; }
        .btn-connect { background: #00b894; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-connect:hover { background: #00947a; }

        /* Chat & Game UI */
        #chat-display { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9rem; display: flex; flex-direction: column; gap: 8px; background: #2c3e50; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
        .msg.me { background: #0984e3; align-self: flex-end; }
        .msg.them { background: #4b6584; align-self: flex-start; }
        .chat-input-area { padding: 10px; display: flex; gap: 5px; background: #2c3e50; border-radius: 0 0 10px 10px; }
        
        .header-panel { display: flex; justify-content: space-between; margin-bottom: 10px; gap: 10px; }
        .player-card { flex: 1; background: #34495e; padding: 10px; border-radius: 8px; text-align: center; border-bottom: 4px solid #7f8c8d; }
        .player-card.active { border-color: #00b894; }
        .score { font-size: 1.2rem; font-weight: bold; color: #f1c40f; }
        
        #myBoard { width: 100%; border: 4px solid #636e72; border-radius: 5px; }
        .status-msg { text-align: center; background: #0984e3; padding: 8px; border-radius: 5px; margin: 10px 0; font-weight: bold; }
        .highlight-hint { box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.7); }
    </style>
</head>
<body>

    <h2 style="margin: 15px 0;">♟️ Chess Online (Custom Room)</h2>
    
    <div class="container">
        <div class="setup-panel">
            <strong>ระบุรหัสห้องเพื่อเชื่อมต่อ:</strong>
            <div class="setup-group">
                <input type="text" id="customRoomInput" class="input-style" placeholder="เช่น cs-pibulsongkram" value="">
                <button class="btn-connect" onclick="connectToRoom()">Connect</button>
            </div>
            <p style="font-size: 0.8rem; color: #bdc3c7; margin-top: 8px;">* พิมพ์รหัสให้เหมือนกับเพื่อน แล้วกด Connect เพื่อเริ่มเล่นค่ะ</p>
        </div>

        <div class="game-side">
            <div class="header-panel">
                <div class="player-card" id="card-w">ขาว: <span id="score-w" class="score">0</span></div>
                <div class="player-card" id="card-b">ดำ: <span id="score-b" class="score">0</span></div>
            </div>
            <div class="status-msg" id="status">กรุณาเชื่อมต่อห้องก่อนค่ะ</div>
            <div id="myBoard"></div>
        </div>

        <div class="chat-side">
            <div style="padding: 12px; background: #2c3e50; border-radius: 10px 10px 0 0; text-align: center; font-weight: bold;">Room Chat</div>
            <div id="chat-display"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="input-style" placeholder="พิมพ์ข้อความ..." onkeydown="if(event.key==='Enter') sendChat()">
                <button class="btn-connect" onclick="sendChat()">ส่ง</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = { databaseURL: "https://sample-chess-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const myId = Math.random().toString(36).substr(2, 5);
        
        var board = null;
        var game = new Chess();
        var currentRoomRef = null;

        // ฟังก์ชันเชื่อมต่อห้อง
        function connectToRoom() {
            const roomId = $('#customRoomInput').val().trim();
            if (!roomId) { alert("กรุณาพิมพ์รหัสห้องด้วยค่ะ"); return; }

            // ล้างข้อมูลหน้าจอเดิม
            $('#chat-display').empty();
            if (currentRoomRef) currentRoomRef.off(); // ยกเลิก Listener เดิม

            currentRoomRef = db.ref('rooms/' + roomId);
            
            // เริ่มฟังข้อมูลจากห้องใหม่
            currentRoomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.fen !== game.fen()) {
                    game.load(data.fen);
                    board.position(data.fen);
                    updateUI();
                }
            });

            // ฟังข้อมูลแชท
            currentRoomRef.child('chat').on('child_added', (snapshot) => {
                const data = snapshot.val();
                const side = data.sender === myId ? 'me' : 'them';
                $('#chat-display').append(`<div class="msg ${side}">${data.message}</div>`);
                $('#chat-display').scrollTop($('#chat-display')[0].scrollHeight);
            });

            $('#status').text("เชื่อมต่อห้อง " + roomId + " สำเร็จ!");
            board.start();
            updateUI();
        }

        function sendChat() {
            if (!currentRoomRef) { alert("กรุณา Connect ห้องก่อนแชทค่ะ"); return; }
            const text = $('#chatInput').val().trim();
            if (text === "") return;
            currentRoomRef.child('chat').push({ sender: myId, message: text, time: Date.now() });
            $('#chatInput').val('');
        }

        function onDrop (source, target) {
            if (!currentRoomRef) return 'snapback';
            $('.highlight-hint').removeClass('highlight-hint');
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            currentRoomRef.update({ fen: game.fen(), lastMove: {from:source, to:target} });
            updateUI();
        }

        function updateUI() {
            const turn = game.turn();
            $('.player-card').removeClass('active');
            $(`#card-${turn}`).addClass('active');
            $('#status').text(game.in_checkmate() ? 'จบเกม! รุกฆาต' : `ตาของสี${turn==='w'?'ขาว':'ดำ'}`);
        }

        board = Chessboard('myBoard', {
            draggable: true,
            position: 'start',
            onDragStart: (s, p) => {
                if (!currentRoomRef || game.game_over() || (game.turn() === 'w' && p.search(/^b/) !== -1) || (game.turn() === 'b' && p.search(/^w/) !== -1)) return false;
                game.moves({square: s, verbose: true}).forEach(m => $(`.square-${m.to}`).addClass('highlight-hint'));
            },
            onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen()),
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    </script>
</body>
</html>
