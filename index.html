<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Chess Pro - Single & Multiplayer</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #1a1a1a; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .menu-container { background: #2d3436; padding: 40px; border-radius: 20px; box-shadow: 0 15px-35px rgba(0,0,0,0.5); text-align: center; width: 350px; transition: 0.5s; }
        .game-container { display: none; width: 100%; max-width: 900px; gap: 20px; flex-wrap: wrap; justify-content: center; }
        
        .btn { padding: 15px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; font-size: 1.1rem; transition: 0.3s; color: white; }
        .btn-main { background: #0984e3; }
        .btn-main:hover { background: #74b9ff; transform: scale(1.05); }
        .btn-green { background: #00b894; }
        .btn-back { background: #636e72; margin-top: 20px; }

        .difficulty-panel { display: none; }
        .online-panel { display: none; }

        /* Game UI */
        #myBoard { width: 100%; max-width: 450px; border: 5px solid #636e72; border-radius: 5px; }
        .chat-side { width: 320px; background: #34495e; border-radius: 10px; display: flex; flex-direction: column; height: 500px; }
        #chat-display { flex: 1; overflow-y: auto; padding: 10px; background: #2c3e50; font-size: 0.9rem; }
        .status-bar { background: #0984e3; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center; font-weight: bold; width: 100%; max-width: 450px; }
    </style>
</head>
<body>

    <div id="main-menu" class="menu-container">
        <h1 style="margin-bottom: 30px;">♟️ Chess Master</h1>
        
        <div id="menu-home">
            <button class="btn btn-main" onclick="showDifficulty()">1. เล่นคนเดียว (VS AI)</button>
            <button class="btn btn-main" onclick="showOnline()">2. เล่นออนไลน์ (Multiplayer)</button>
        </div>

        <div id="menu-difficulty" class="difficulty-panel">
            <h3>เลือกระดับความยาก</h3>
            <button class="btn btn-green" onclick="startSinglePlayer(1)">ง่าย (หัดเดิน)</button>
            <button class="btn btn-green" onclick="startSinglePlayer(2)">ปานกลาง (ท้าทาย)</button>
            <button class="btn btn-green" onclick="startSinglePlayer(3)">ยาก (เซียน)</button>
            <button class="btn btn-back" onclick="goBack()">ย้อนกลับ</button>
        </div>

        <div id="menu-online" class="online-panel">
            <h3>ตั้งค่าห้องออนไลน์</h3>
            <input type="text" id="roomName" style="width:100%; padding:10px; margin-bottom:10px; border-radius:5px;" placeholder="ชื่อห้อง">
            <input type="text" id="playerName" style="width:100%; padding:10px; margin-bottom:10px; border-radius:5px;" placeholder="ชื่อของเธอ">
            <button class="btn btn-green" onclick="setupOnline('host')">สร้างห้อง & รอเพื่อน</button>
            <button class="btn btn-main" onclick="setupOnline('guest')">ขอเข้าห้องเพื่อน</button>
            <button class="btn btn-back" onclick="goBack()">ย้อนกลับ</button>
        </div>
    </div>

    <div id="game-screen" class="game-container">
        <div style="flex: 1; min-width: 350px; max-width: 450px;">
            <div id="approval-box" style="display:none; background:#e67e22; padding:10px; border-radius:8px; margin-bottom:10px;">
                <span id="req-info"></span>
                <button onclick="approveFriend()" style="padding:5px 10px; border-radius:5px; border:none; cursor:pointer;">อนุญาต</button>
            </div>
            <div class="status-bar" id="status">กำลังโหลด...</div>
            <div id="myBoard"></div>
            <button class="btn btn-back" onclick="location.reload()">กลับเมนูหลัก</button>
        </div>

        <div class="chat-side" id="chat-side">
            <div style="padding:15px; text-align:center; font-weight:bold; border-bottom:1px solid #4b6584;">Room Chat</div>
            <div id="chat-display"></div>
            <div style="padding:10px; background:#2c3e50; display:flex; gap:5px;">
                <input type="text" id="chatInput" style="flex:1; padding:8px; border-radius:5px; border:none;" placeholder="พิมพ์ข้อความ...">
                <button class="btn btn-green" style="width:auto; margin:0; padding:5px 15px;" onclick="sendChat()">ส่ง</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://sample-chess-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const myId = Math.random().toString(36).substr(2, 5);
        
        var board = null, game = new Chess(), currentRoomRef = null, isOnline = false, aiLevel = 0;

        // --- ระบบเมนู ---
        function showDifficulty() { $('#menu-home').hide(); $('#menu-difficulty').show(); }
        function showOnline() { $('#menu-home').hide(); $('#menu-online').show(); }
        function goBack() { $('.difficulty-panel, .online-panel').hide(); $('#menu-home').show(); }

        // --- โหมดเล่นคนเดียว (AI) ---
        function startSinglePlayer(level) {
            aiLevel = level;
            isOnline = false;
            $('#main-menu').hide();
            $('#game-screen').css('display', 'flex');
            $('#chat-side').hide(); // ปิดแชทถ้าเล่นกับ AI
            initBoard();
            updateStatus("เล่นกับ AI ระดับ: " + (level==1?'ง่าย':level==2?'กลาง':'ยาก'));
        }

        function makeAIMove() {
            if (game.game_over()) return;
            setTimeout(() => {
                const moves = game.moves();
                // AI แบบสุ่ม (ง่าย) หรือเลือกกินตัว (กลาง-ยาก)
                const move = moves[Math.floor(Math.random() * moves.length)];
                game.move(move);
                board.position(game.fen());
                updateStatus();
            }, 500 * aiLevel);
        }

        // --- โหมดออนไลน์ ---
        function setupOnline(role) {
            const room = $('#roomName').val();
            const name = $('#playerName').val();
            if(!room || !name) return alert("กรุณากรอกข้อมูลให้ครบค่ะ");

            isOnline = true;
            currentRoomRef = db.ref('rooms/' + room);
            $('#main-menu').hide();
            $('#game-screen').css('display', 'flex');
            initBoard();

            if(role === 'host') {
                currentRoomRef.set({ hostId: myId, hostName: name, status: 'waiting', fen: 'start' });
                updateStatus("รอเพื่อนขอเข้าร่วม...");
            } else {
                currentRoomRef.update({ guestId: myId, guestName: name, requestJoin: true });
                updateStatus("รอ Host อนุญาต...");
            }

            listenFirebase();
        }

        function listenFirebase() {
            currentRoomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if(!data) return;
                
                if(data.status === 'waiting' && data.requestJoin && data.hostId === myId) {
                    $('#approval-box').show();
                    $('#req-info').text(data.guestName + " ขอเข้าเล่นด้วยค่ะ");
                }
                
                if(data.status === 'active') {
                    $('#approval-box').hide();
                    if(data.fen !== game.fen()) {
                        game.load(data.fen);
                        board.position(game.fen());
                        updateStatus();
                    }
                }
            });

            currentRoomRef.child('chat').on('child_added', (snapshot) => {
                const d = snapshot.val();
                $('#chat-display').append(`<div><b>${d.sender===myId?'ฉัน':'เพื่อน'}:</b> ${d.message}</div>`);
                $('#chat-display').scrollTop($('#chat-display')[0].scrollHeight);
            });
        }

        function approveFriend() {
            currentRoomRef.update({ status: 'active', requestJoin: false });
        }

        // --- ระบบบอร์ดเกม ---
        function initBoard() {
            board = Chessboard('myBoard', {
                draggable: true,
                position: 'start',
                onDragStart: (s, p) => {
                    if (game.game_over() || (game.turn() === 'w' && p.search(/^b/) !== -1) || (game.turn() === 'b' && p.search(/^w/) !== -1)) return false;
                },
                onDrop: (s, t) => {
                    let move = game.move({ from: s, to: t, promotion: 'q' });
                    if (!move) return 'snapback';
                    
                    if(isOnline) {
                        currentRoomRef.update({ fen: game.fen() });
                    } else {
                        updateStatus();
                        makeAIMove();
                    }
                }
            });
        }

        function updateStatus(customMsg) {
            const status = customMsg || (game.in_checkmate() ? "จบเกม! รุกฆาต" : "ตาของสี" + (game.turn()==='w'?'ขาว':'ดำ'));
            $('#status').text(status);
        }

        function sendChat() {
            const text = $('#chatInput').val();
            if(text && currentRoomRef) {
                currentRoomRef.child('chat').push({ sender: myId, message: text });
                $('#chatInput').val('');
            }
        }
    </script>
</body>
</html>
