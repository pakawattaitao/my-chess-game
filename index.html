<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Chess Online - Chat & Multiplayer</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #1a1a1a; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .container { background: #2d3436; padding: 20px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); width: 100%; max-width: 800px; display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        
        .game-side { flex: 1; min-width: 350px; max-width: 450px; }
        .chat-side { width: 300px; background: #34495e; border-radius: 10px; display: flex; flex-direction: column; height: 500px; }

        /* Chat UI */
        #chat-display { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9rem; display: flex; flex-direction: column; gap: 5px; }
        .msg { padding: 8px 12px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .msg.me { background: #0984e3; align-self: flex-end; }
        .msg.them { background: #4b6584; align-self: flex-start; }
        .chat-input-area { padding: 10px; display: flex; gap: 5px; background: #2c3e50; border-radius: 0 0 10px 10px; }
        .chat-input-area input { flex: 1; padding: 8px; border-radius: 5px; border: none; }
        
        /* Game UI */
        .header-panel { display: flex; justify-content: space-between; margin-bottom: 10px; gap: 10px; }
        .player-card { flex: 1; background: #34495e; padding: 8px; border-radius: 8px; text-align: center; font-size: 0.8rem; border-bottom: 3px solid #7f8c8d; }
        .player-card.active { border-color: #00b894; }
        #myBoard { width: 100%; border: 4px solid #636e72; border-radius: 5px; }
        .status-msg { text-align: center; background: #0984e3; padding: 5px; border-radius: 5px; margin: 10px 0; font-size: 0.9rem; font-weight: bold; }
        
        .share-panel { background: #34495e; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.75rem; width: 100%; }
        .share-input-group { display: flex; gap: 5px; margin-top: 5px; }
        .copy-btn { background: #00b894; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .highlight-hint { box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.7); }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">♟️ Chess Online & Real-time Chat</h2>
    
    <div class="container">
        <div class="game-side">
            <div class="header-panel">
                <div class="player-card" id="card-w">⚪ ขาว: <span id="score-w">0</span></div>
                <div class="player-card" id="card-b">⚫ ดำ: <span id="score-b">0</span></div>
            </div>
            <div class="status-msg" id="status">รอเพื่อนเชื่อมต่อ...</div>
            <div id="myBoard"></div>
            
            <div class="share-panel">
                <strong>Link ชวนเพื่อน:</strong>
                <div class="share-input-group">
                    <input type="text" id="shareUrl" readonly>
                    <button class="copy-btn" onclick="copyLink()">ก๊อปปี้</button>
                </div>
            </div>
        </div>

        <div class="chat-side">
            <div style="padding: 10px; background: #2c3e50; border-radius: 10px 10px 0 0; text-align: center; font-weight: bold; border-bottom: 1px solid #4b6584;">ห้องสนทนา</div>
            <div id="chat-display"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="พิมพ์ข้อความที่นี่..." onkeydown="if(event.key==='Enter') sendChat()">
                <button class="copy-btn" onclick="sendChat()">ส่ง</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room') || ('room-' + Math.random().toString(36).substr(2, 9));
        if (!urlParams.get('room')) window.history.pushState({}, '', '?room=' + roomId);
        document.getElementById('shareUrl').value = window.location.href;

        const firebaseConfig = { databaseURL: "https://sample-chess-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const roomRef = db.ref('rooms/' + roomId);
        const myId = Math.random().toString(36).substr(2, 5);

        var board = null;
        var game = new Chess();

        // --- ระบบแชท ---
        function sendChat() {
            const text = $('#chatInput').val().trim();
            if (text === "") return;
            roomRef.child('chat').push({ sender: myId, message: text, time: Date.now() });
            $('#chatInput').val('');
        }

        roomRef.child('chat').limitToLast(20).on('child_added', (snapshot) => {
            const data = snapshot.val();
            const side = data.sender === myId ? 'me' : 'them';
            $('#chat-display').append(`<div class="msg ${side}">${data.message}</div>`);
            $('#chat-display').scrollTop($('#chat-display')[0].scrollHeight);
        });

        // --- ระบบเกม ---
        function updateUI() {
            const turn = game.turn();
            $('.player-card').removeClass('active');
            $(`#card-${turn}`).addClass('active');
            $('#status').text(game.in_checkmate() ? 'รุกฆาต! เกมจบแล้วค่ะ' : `ตาของสี${turn==='w'?'ขาว':'ดำ'}`);
        }

        function onDrop (source, target) {
            $('.highlight-hint').removeClass('highlight-hint');
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            roomRef.update({ fen: game.fen(), lastMove: {from:source, to:target} });
            updateUI();
        }

        roomRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.fen !== game.fen()) {
                game.load(data.fen);
                board.position(data.fen);
                updateUI();
            }
        });

        function copyLink() {
            const copyText = document.getElementById("shareUrl");
            copyText.select();
            document.execCommand("copy");
            alert("ก๊อปปี้ลิงก์ส่งให้เพื่อนแล้วนะคะ!");
        }

        board = Chessboard('myBoard', {
            draggable: true,
            position: 'start',
            onDragStart: (s, p) => {
                if (game.game_over() || (game.turn() === 'w' && p.search(/^b/) !== -1) || (game.turn() === 'b' && p.search(/^w/) !== -1)) return false;
                game.moves({square: s, verbose: true}).forEach(m => $(`.square-${m.to}`).addClass('highlight-hint'));
            },
            onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen()),
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        updateUI();
    </script>
</body>
</html>